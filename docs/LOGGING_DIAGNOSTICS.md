# Диагностика синхронизации с FimBiz - Что смотреть в логах

## Обзор

Добавлено расширенное логирование для диагностики проблем с синхронизацией заказов и контрагентов с FimBiz.

## Что смотреть в логах

### 1. Входящие gRPC запросы от FimBiz (ЗАКАЗЫ)

#### Ищите строки с маркерами:
- `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС NotifyOrderStatusChange ===`
- `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС NotifyOrderUpdate ===`
- `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС NotifyOrderDelete ===`

#### Что проверять:

**Если НЕТ таких строк:**
- ❌ FimBiz **НЕ отправляет** запросы на ваш сервер
- Проверьте:
  - Правильно ли настроен URL вашего gRPC сервера в FimBiz
  - Доступен ли ваш сервер из сети FimBiz (firewall, NAT)
  - Правильно ли настроен API ключ в FimBiz

**Если ЕСТЬ такие строки:**
- ✅ Запросы приходят, проверьте дальше:

1. **RemoteAddress** - IP адрес отправителя (должен быть из FimBiz)
2. **API ключ** - проверьте, что он совпадает с ожидаемым
3. **Данные запроса** - проверьте ExternalOrderId, FimBizOrderId, Status

#### Пример успешного запроса:
```
info: === [ORDER] ВХОДЯЩИЙ ЗАПРОС NotifyOrderStatusChange ===
info: RemoteAddress: ipv4:192.168.1.100:54321
info: Request.ExternalOrderId: 123e4567-e89b-12d3-a456-426614174000
info: Request.FimBizOrderId: 12345
info: Request.NewStatus: Assembled
```

#### Пример проблемы с API ключом:
```
warn: API ключ из запроса: ОТСУТСТВУЕТ
warn: Неверный или отсутствующий API ключ при обновлении статуса заказа
```

---

### 2. Входящие gRPC запросы от FimBiz (КОНТРАГЕНТЫ)

#### Ищите строки с маркерами:
- `=== [CONTRACTOR] ВХОДЯЩИЙ ЗАПРОС GetActiveSessions ===`
- `=== [CONTRACTOR] ВХОДЯЩИЙ ЗАПРОС ExecuteSessionControl ===`

#### Что проверять:
- Приходят ли запросы от FimBiz для управления сессиями контрагентов

---

### 3. Подписка на изменения контрагентов (ИСХОДЯЩИЙ СТРИМ)

#### Ищите строки с маркерами:
- `=== [CONTRACTOR] ПОДПИСКА АКТИВНА, ОЖИДАЕМ ИЗМЕНЕНИЯ ===`
- `=== [CONTRACTOR] ПОЛУЧЕН СТРИМ ИЗМЕНЕНИЙ ===`
- `=== [CONTRACTOR] ПОЛУЧЕНО ИЗМЕНЕНИЕ ОТ FIMBIZ ===`
- `=== [CONTRACTOR] ОШИБКА gRPC ПРИ ПОДПИСКЕ ===`

#### Что проверять:

**Если видите "ПОДПИСКА АКТИВНА":**
- ✅ Подписка установлена, но изменений нет
- Возможные причины:
  - В FimBiz нет изменений контрагентов
  - FimBiz не отправляет изменения через стрим

**Если видите "ПОЛУЧЕН СТРИМ ИЗМЕНЕНИЙ":**
- ✅ Изменения приходят, проверьте детали в следующей строке

**Если видите "ОШИБКА gRPC ПРИ ПОДПИСКЕ":**
- ❌ Проблема с подключением к FimBiz
- Проверьте:
  - StatusCode (должен быть указан)
  - Detail (детали ошибки)
  - Доступность FimBiz сервера

#### Пример успешной подписки:
```
info: Подписка на изменения контрагентов для магазина Default Shop (CompanyId: 0) с версии 18
info: === [CONTRACTOR] ПОДПИСКА АКТИВНА, ОЖИДАЕМ ИЗМЕНЕНИЯ ===
info: === [CONTRACTOR] ПОЛУЧЕН СТРИМ ИЗМЕНЕНИЙ ===
info: === [CONTRACTOR] ПОЛУЧЕНО ИЗМЕНЕНИЕ ОТ FIMBIZ ===
info: ChangeType: Updated
info: ContractorId: 12345
```

#### Пример ошибки подписки:
```
error: === [CONTRACTOR] ОШИБКА gRPC ПРИ ПОДПИСКЕ ===
error: StatusCode: Unimplemented, Detail: Bad gRPC response. HTTP status code: 404
```

---

### 4. Обработка заказов

#### Ищите строки:
- `Получено уведомление об изменении статуса заказа`
- `Получено уведомление об обновлении заказа`
- `Получено уведомление об удалении заказа`
- `Заказ {OrderId} не найден`
- `Заказ {OrderId} не изменился, пропускаем обновление`
- `Статус заказа {OrderId} успешно обновлен`

#### Что проверять:

**Если видите "Заказ не найден":**
- ❌ Заказ с таким ExternalOrderId отсутствует в БД
- Проверьте, был ли заказ создан в интернет-магазине

**Если видите "Заказ не изменился":**
- ⚠️ Данные от FimBiz идентичны текущим в БД
- Это нормально, если FimBiz отправляет дубликаты

**Если видите "успешно обновлен":**
- ✅ Изменения применены

---

## Типичные проблемы и решения

### Проблема 1: Запросы от FimBiz не приходят

**Симптомы:**
- Нет строк `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС ===` в логах
- Но удаление заказов работает (значит gRPC сервер доступен)

**Возможные причины:**
1. FimBiz не настроен на отправку `NotifyOrderStatusChange` и `NotifyOrderUpdate`
2. FimBiz отправляет запросы, но они не доходят до сервера
3. Неправильный URL gRPC сервера в настройках FimBiz

**Что делать:**
- Проверьте настройки FimBiz (куда отправлять уведомления)
- Проверьте логи FimBiz (отправляет ли он запросы)
- Проверьте сетевую доступность вашего сервера

---

### Проблема 2: Ошибка "Invalid API key"

**Симптомы:**
- Видите строки `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС ===`
- Но затем `Неверный или отсутствующий API ключ`

**Что делать:**
- Проверьте, что API ключ в `appsettings.json` совпадает с тем, что отправляет FimBiz
- Проверьте заголовок `x-api-key` в запросе

---

### Проблема 3: Подписка на контрагентов не работает

**Симптомы:**
- Видите `=== [CONTRACTOR] ОШИБКА gRPC ПРИ ПОДПИСКЕ ===`
- StatusCode: `Unimplemented` или `NotFound`

**Что делать:**
- Это проблема на стороне FimBiz - метод `SubscribeToChanges` не реализован
- Обратитесь к разработчикам FimBiz

---

### Проблема 4: Запросы приходят, но заказы не обновляются

**Симптомы:**
- Видите `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС ===`
- Но не видите `успешно обновлен`

**Что делать:**
- Проверьте логи после строки с запросом:
  - Есть ли ошибки?
  - Есть ли "Заказ не найден"?
  - Есть ли "Заказ не изменился"?

---

## Рекомендации по мониторингу

1. **Регулярно проверяйте логи** на наличие:
   - `=== [ORDER] ВХОДЯЩИЙ ЗАПРОС ===` - должны появляться при изменениях заказов
   - `=== [CONTRACTOR] ПОЛУЧЕНО ИЗМЕНЕНИЕ ===` - должны появляться при изменениях контрагентов

2. **Настройте алерты** на:
   - Отсутствие входящих запросов более N минут (если ожидаются изменения)
   - Ошибки gRPC (`ОШИБКА gRPC`)
   - Ошибки "Заказ не найден" (может указывать на проблему синхронизации)

3. **Проверяйте при старте сервера:**
   - `Подписка на изменения контрагентов` - должна быть установлена
   - `=== [CONTRACTOR] ПОДПИСКА АКТИВНА ===` - должна появиться

---

## Формат логов

Все диагностические логи имеют префиксы:
- `=== [ORDER] ===` - для заказов
- `=== [CONTRACTOR] ===` - для контрагентов

Это позволяет легко фильтровать логи:
```bash
# Linux/Mac
grep "=== \[ORDER\]" logs/app.log

# Windows PowerShell
Select-String "=== \[ORDER\]" logs/app.log
```

